import tkinter as tk
from tkinter import ttk, messagebox
import subprocess
import sys
import os
import threading
import time
import base64
import shutil
import datetime

# Base64 encoded source code
APP_CODE_B64 = "aW1wb3J0IGN1c3RvbXRraW50ZXIgYXMgY3RrCmltcG9ydCBzb3VuZGRldmljZSBhcyBzZAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHRocmVhZGluZwppbXBvcnQgcXVldWUKaW1wb3J0IHdoaXNwZXIKaW1wb3J0IGRhdGV0aW1lCmltcG9ydCBvcwppbXBvcnQgc3lzCmltcG9ydCBsb2dnaW5nCmltcG9ydCB0b3JjaAppbXBvcnQgc3VicHJvY2VzcwppbXBvcnQgd2ViYnJvd3NlcgppbXBvcnQgcmUKZnJvbSB0a2ludGVyIGltcG9ydCBtZXNzYWdlYm94LCBmaWxlZGlhbG9nCgojIFNldHVwIGxvZ2dpbmcKbG9nZ2luZy5iYXNpY0NvbmZpZyhmaWxlbmFtZT0nYXBwX2RlYnVnLmxvZycsIGxldmVsPWxvZ2dpbmcuREVCVUcsIAogICAgICAgICAgICAgICAgICAgIGZvcm1hdD0nJShhc2N0aW1lKXMgLSAlKGxldmVsbmFtZSlzIC0gJShtZXNzYWdlKXMnKQoKIyBDb25maWd1cmF0aW9uClNBTVBMRV9SQVRFID0gMTYwMDAKQ0hBTk5FTFMgPSAxCkFQUF9WRVJTSU9OID0gInYwLjYuMSIKCiMgTW9kZWwgc2l6ZXMgbWFwCk1PREVMX1NJWkVTID0gewogICAgInRpbnkiOiAidGlueSAofjc1IE1CKSIsCiAgICAiYmFzZSI6ICJiYXNlICh+MTQ1IE1CKSIsCiAgICAic21hbGwiOiAic21hbGwgKH40NjEgTUIpIiwKICAgICJtZWRpdW0iOiAibWVkaXVtICh+MS41IEdCKSIsCiAgICAibGFyZ2UiOiAibGFyZ2UgKH4zIEdCKSIKfQpSRVZFUlNFX01PREVMX01BUCA9IHt2OiBrIGZvciBrLCB2IGluIE1PREVMX1NJWkVTLml0ZW1zKCl9CgojIENodW5rIG9wdGlvbnMgKExhYmVsIC0+IFNlY29uZHMpCkNIVU5LX09QVElPTlMgPSB7CiAgICAiNXMgKEZhc3Rlc3QpIjogNSwKICAgICIxMHMgKEJhbGFuY2VkKSI6IDEwLAogICAgIjE1cyI6IDE1LAogICAgIjIwcyI6IDIwLAogICAgIjMwcyAoQmVzdCBDb250ZXh0KSI6IDMwCn0KUkVWRVJTRV9DSFVOS19NQVAgPSB7djogayBmb3IgaywgdiBpbiBDSFVOS19PUFRJT05TLml0ZW1zKCl9CgpjbGFzcyBTdGRFcnJSZWRpcmVjdG9yOgogICAgIiIiQ2FwdHVyZXMgc3RkZXJyICh0cWRtIHByb2dyZXNzIGJhcnMpIHRvIHVwZGF0ZSB0aGUgR1VJLiIiIgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGNhbGxiYWNrKToKICAgICAgICBzZWxmLmNhbGxiYWNrID0gY2FsbGJhY2sKICAgICAgICBzZWxmLm9yaWdpbmFsX3N0ZGVyciA9IHN5cy5zdGRlcnIKCiAgICBkZWYgd3JpdGUoc2VsZiwgYnVmKToKICAgICAgICAjIE9ubHkgd3JpdGUgdG8gb3JpZ2luYWwgc3RkZXJyIGlmIGl0IGV4aXN0cyAoaXQgbWlnaHQgYmUgTm9uZSBpbiBweXRob253KQogICAgICAgIGlmIHNlbGYub3JpZ2luYWxfc3RkZXJyOgogICAgICAgICAgICBzZWxmLm9yaWdpbmFsX3N0ZGVyci53cml0ZShidWYpCiAgICAgICAgICAgIAogICAgICAgIG1hdGNoID0gcmUuc2VhcmNoKHInKFxkKyklJywgYnVmKQogICAgICAgIGlmIG1hdGNoOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBwZXJjZW50ID0gaW50KG1hdGNoLmdyb3VwKDEpKQogICAgICAgICAgICAgICAgc2VsZi5jYWxsYmFjayhwZXJjZW50IC8gMTAwLjApCiAgICAgICAgICAgIGV4Y2VwdDoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgZmx1c2goc2VsZik6CiAgICAgICAgaWYgc2VsZi5vcmlnaW5hbF9zdGRlcnI6CiAgICAgICAgICAgIHNlbGYub3JpZ2luYWxfc3RkZXJyLmZsdXNoKCkKCiAgICBkZWYgc3RhcnQoc2VsZik6CiAgICAgICAgc3lzLnN0ZGVyciA9IHNlbGYKCiAgICBkZWYgc3RvcChzZWxmKToKICAgICAgICBzeXMuc3RkZXJyID0gc2VsZi5vcmlnaW5hbF9zdGRlcnIKCmNsYXNzIEF1ZGlvUmVjb3JkZXI6CiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5yZWNvcmRpbmcgPSBGYWxzZQogICAgICAgIHNlbGYucGF1c2VkID0gRmFsc2UKICAgICAgICBzZWxmLmF1ZGlvX3F1ZXVlID0gcXVldWUuUXVldWUoKQogICAgICAgIHNlbGYuc3RyZWFtID0gTm9uZQogICAgICAgIHNlbGYuZGV2aWNlX2luZGV4ID0gTm9uZQogICAgICAgIHNlbGYuYXVkaW9fYnVmZmVyID0gW10KICAgICAgICBzZWxmLmJ1ZmZlcl9zYW1wbGVfY291bnQgPSAwCiAgICAgICAgc2VsZi5jaHVua19kdXJhdGlvbl9zYW1wbGVzID0gMAogICAgICAgIHNlbGYubG9jayA9IHRocmVhZGluZy5Mb2NrKCkKCiAgICBkZWYgc3RhcnQoc2VsZiwgZGV2aWNlX2luZGV4LCBjaHVua19kdXJhdGlvbik6CiAgICAgICAgbG9nZ2luZy5pbmZvKGYiU3RhcnRpbmcgcmVjb3JkZXIgb24gZGV2aWNlIHtkZXZpY2VfaW5kZXh9IHdpdGggY2h1bmsge2NodW5rX2R1cmF0aW9ufXMiKQogICAgICAgIHNlbGYuZGV2aWNlX2luZGV4ID0gZGV2aWNlX2luZGV4CiAgICAgICAgc2VsZi5jaHVua19kdXJhdGlvbl9zYW1wbGVzID0gaW50KFNBTVBMRV9SQVRFICogY2h1bmtfZHVyYXRpb24pCiAgICAgICAgc2VsZi5hdWRpb19idWZmZXIgPSBbXQogICAgICAgIHNlbGYuYnVmZmVyX3NhbXBsZV9jb3VudCA9IDAKICAgICAgICBzZWxmLnJlY29yZGluZyA9IFRydWUKICAgICAgICBzZWxmLnBhdXNlZCA9IEZhbHNlCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnN0cmVhbSA9IHNkLklucHV0U3RyZWFtKAogICAgICAgICAgICAgICAgZGV2aWNlPXNlbGYuZGV2aWNlX2luZGV4LAogICAgICAgICAgICAgICAgY2hhbm5lbHM9Q0hBTk5FTFMsCiAgICAgICAgICAgICAgICBzYW1wbGVyYXRlPVNBTVBMRV9SQVRFLAogICAgICAgICAgICAgICAgY2FsbGJhY2s9c2VsZi5hdWRpb19jYWxsYmFjaywKICAgICAgICAgICAgICAgIGJsb2Nrc2l6ZT00MDk2IAogICAgICAgICAgICApCiAgICAgICAgICAgIHNlbGYuc3RyZWFtLnN0YXJ0KCkKICAgICAgICAgICAgbG9nZ2luZy5pbmZvKCJTdHJlYW0gc3RhcnRlZCBzdWNjZXNzZnVsbHkiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcihmIkVycm9yIHN0YXJ0aW5nIHN0cmVhbToge2V9IikKICAgICAgICAgICAgcmFpc2UKCiAgICBkZWYgYXVkaW9fY2FsbGJhY2soc2VsZiwgaW5kYXRhLCBmcmFtZXMsIHRpbWUsIHN0YXR1cyk6CiAgICAgICAgaWYgc3RhdHVzOgogICAgICAgICAgICBsb2dnaW5nLndhcm5pbmcoZiJBdWRpbyBjYWxsYmFjayBzdGF0dXM6IHtzdGF0dXN9IikKICAgICAgICBpZiBzZWxmLnJlY29yZGluZyBhbmQgbm90IHNlbGYucGF1c2VkOgogICAgICAgICAgICB3aXRoIHNlbGYubG9jazoKICAgICAgICAgICAgICAgIHNlbGYuYXVkaW9fYnVmZmVyLmFwcGVuZChpbmRhdGEuY29weSgpKQogICAgICAgICAgICAgICAgc2VsZi5idWZmZXJfc2FtcGxlX2NvdW50ICs9IGZyYW1lcwogICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAjIENoZWNrIGlmIHdlIGhhdmUgZW5vdWdoIGRhdGEgZm9yIGEgZnVsbCBjaHVuawogICAgICAgICAgICAgICAgaWYgc2VsZi5idWZmZXJfc2FtcGxlX2NvdW50ID49IHNlbGYuY2h1bmtfZHVyYXRpb25fc2FtcGxlczoKICAgICAgICAgICAgICAgICAgICAjIENvbWJpbmUgYnVmZmVyZWQgYmxvY2tzCiAgICAgICAgICAgICAgICAgICAgZnVsbF9kYXRhID0gbnAuY29uY2F0ZW5hdGUoc2VsZi5hdWRpb19idWZmZXIpCiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgIyBFeHRyYWN0IGNodW5rIGFuZCByZW1haW5kZXIKICAgICAgICAgICAgICAgICAgICBjaHVuayA9IGZ1bGxfZGF0YVs6c2VsZi5jaHVua19kdXJhdGlvbl9zYW1wbGVzXQogICAgICAgICAgICAgICAgICAgIHJlbWFpbmRlciA9IGZ1bGxfZGF0YVtzZWxmLmNodW5rX2R1cmF0aW9uX3NhbXBsZXM6XQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgU2VuZCB0aGUgZnVsbCBjaHVuawogICAgICAgICAgICAgICAgICAgIHNlbGYuYXVkaW9fcXVldWUucHV0KGNodW5rKQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgICMgUmVzZXQgYnVmZmVyIHdpdGggcmVtYWluZGVyCiAgICAgICAgICAgICAgICAgICAgc2VsZi5hdWRpb19idWZmZXIgPSBbcmVtYWluZGVyXSBpZiBsZW4ocmVtYWluZGVyKSA+IDAgZWxzZSBbXQogICAgICAgICAgICAgICAgICAgIHNlbGYuYnVmZmVyX3NhbXBsZV9jb3VudCA9IGxlbihyZW1haW5kZXIpCgogICAgZGVmIHBhdXNlKHNlbGYpOgogICAgICAgIHNlbGYucGF1c2VkID0gVHJ1ZQoKICAgIGRlZiByZXN1bWUoc2VsZik6CiAgICAgICAgc2VsZi5wYXVzZWQgPSBGYWxzZQoKICAgIGRlZiBzdG9wKHNlbGYpOgogICAgICAgIHNlbGYucmVjb3JkaW5nID0gRmFsc2UKICAgICAgICBpZiBzZWxmLnN0cmVhbToKICAgICAgICAgICAgc2VsZi5zdHJlYW0uc3RvcCgpCiAgICAgICAgICAgIHNlbGYuc3RyZWFtLmNsb3NlKCkKICAgICAgICAgICAgc2VsZi5zdHJlYW0gPSBOb25lCiAgICAgICAgCiAgICAgICAgIyBGbHVzaCBhbnkgcmVtYWluaW5nIGF1ZGlvIGluIHRoZSBidWZmZXIKICAgICAgICB3aXRoIHNlbGYubG9jazoKICAgICAgICAgICAgaWYgc2VsZi5hdWRpb19idWZmZXI6CiAgICAgICAgICAgICAgICByZW1haW5pbmdfZGF0YSA9IG5wLmNvbmNhdGVuYXRlKHNlbGYuYXVkaW9fYnVmZmVyKQogICAgICAgICAgICAgICAgIyBPbmx5IHRyYW5zY3JpYmUgaWYgdGhlcmUgaXMgc2lnbmlmaWNhbnQgYXVkaW8gbGVmdCAoPjAuMXMpCiAgICAgICAgICAgICAgICBpZiBsZW4ocmVtYWluaW5nX2RhdGEpID4gaW50KFNBTVBMRV9SQVRFICogMC4xKToKICAgICAgICAgICAgICAgICAgICBsb2dnaW5nLmluZm8oZiJGbHVzaGluZyBmaW5hbCBidWZmZXI6IHtsZW4ocmVtYWluaW5nX2RhdGEpfSBzYW1wbGVzIikKICAgICAgICAgICAgICAgICAgICBzZWxmLmF1ZGlvX3F1ZXVlLnB1dChyZW1haW5pbmdfZGF0YSkKICAgICAgICAgICAgICAgIHNlbGYuYXVkaW9fYnVmZmVyID0gW10KICAgICAgICAgICAgICAgIHNlbGYuYnVmZmVyX3NhbXBsZV9jb3VudCA9IDAKCmNsYXNzIFRyYW5zY3JpYmVyQXBwKGN0ay5DVGspOgogICAgZGVmIF9faW5pdF9fKHNlbGYpOgogICAgICAgIHN1cGVyKCkuX19pbml0X18oKQogICAgICAgIAogICAgICAgIHNlbGYudGl0bGUoZiJMb2NhbCBUcmFuc2NyaWJlciBQcm8ge0FQUF9WRVJTSU9OfSIpCiAgICAgICAgc2VsZi5nZW9tZXRyeSgiOTUweDgwMCIpCiAgICAgICAgY3RrLnNldF9hcHBlYXJhbmNlX21vZGUoIkRhcmsiKQogICAgICAgIGN0ay5zZXRfZGVmYXVsdF9jb2xvcl90aGVtZSgiYmx1ZSIpCgogICAgICAgIHNlbGYucmVjb3JkZXIgPSBBdWRpb1JlY29yZGVyKCkKICAgICAgICBzZWxmLm1vZGVsID0gTm9uZQogICAgICAgIHNlbGYubW9kZWxfbmFtZSA9IE5vbmUKICAgICAgICBzZWxmLnRyYW5zY3JpcHRpb25fdGhyZWFkID0gTm9uZQogICAgICAgIHNlbGYucnVubmluZyA9IFRydWUKICAgICAgICBzZWxmLmZ1bGxfdHJhbnNjcmlwdCA9IFtdCiAgICAgICAgc2VsZi5zZXNzaW9uX3N0YXJ0X3RpbWUgPSBOb25lCiAgICAgICAgc2VsZi5pc19sb2FkaW5nX21vZGVsID0gRmFsc2UKICAgICAgICBzZWxmLmN1ZGFfbWlzc2luZyA9IEZhbHNlCiAgICAgICAgc2VsZi5yZWRpcmVjdG9yID0gTm9uZQogICAgICAgIHNlbGYuYmFja3VwX2ZpbGUgPSBvcy5wYXRoLmpvaW4ob3MuZ2V0Y3dkKCksICIudW5zYXZlZF9zZXNzaW9uLnR4dCIpCgogICAgICAgIHNlbGYuY2hlY2tfaGFyZHdhcmVfc3RhdHVzKCkKICAgICAgICBzZWxmLnNldHVwX3VpKCkKICAgICAgICBzZWxmLnNldHVwX2JpbmRpbmdzKCkKICAgICAgICBzZWxmLmNoZWNrX3JlY292ZXJ5KCkKICAgICAgICBzZWxmLnByb3RvY29sKCJXTV9ERUxFVEVfV0lORE9XIiwgc2VsZi5vbl9jbG9zZSkKCiAgICBkZWYgY2hlY2tfcmVjb3Zlcnkoc2VsZik6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5iYWNrdXBfZmlsZSk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHdpdGggb3BlbihzZWxmLmJhY2t1cF9maWxlLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgY29udGVudCA9IGYucmVhZCgpLnN0cmlwKCkKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgaWYgY29udGVudDoKICAgICAgICAgICAgICAgICAgICBsaW5lcyA9IGNvbnRlbnQuc3BsaXQoJ1xuJykKICAgICAgICAgICAgICAgICAgICBzZWxmLmZ1bGxfdHJhbnNjcmlwdCA9IGxpbmVzCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dfbWVzc2FnZSgiXG5bU3lzdGVtXSDimqDvuI8gUkVDT1ZFUkVEIFVOU0FWRUQgU0VTU0lPTiBGUk9NIFBSRVZJT1VTIFJVTjoiKQogICAgICAgICAgICAgICAgICAgIGZvciBsaW5lIGluIGxpbmVzOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLmxvZ19tZXNzYWdlKGxpbmUpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5sb2dfbWVzc2FnZSgiLSIgKiA0MCArICJcbiIpCiAgICAgICAgICAgICAgICAgICAgbWVzc2FnZWJveC5zaG93aW5mbygiU2Vzc2lvbiBSZWNvdmVyZWQiLCAiV2UgZm91bmQgYW4gdW5zYXZlZCB0cmFuc2NyaXB0IGZyb20gYSBwcmV2aW91cyBzZXNzaW9uIGFuZCByZXN0b3JlZCBpdC4iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBsb2dnaW5nLmVycm9yKGYiUmVjb3ZlcnkgZmFpbGVkOiB7ZX0iKQoKICAgIGRlZiBhcHBlbmRfdG9fYmFja3VwKHNlbGYsIHRleHQpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKHNlbGYuYmFja3VwX2ZpbGUsICJhIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGYud3JpdGUodGV4dCArICJcbiIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBsb2dnaW5nLmVycm9yKGYiQmFja3VwIGZhaWxlZDoge2V9IikKCiAgICBkZWYgY2xlYXJfYmFja3VwKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMoc2VsZi5iYWNrdXBfZmlsZSk6CiAgICAgICAgICAgICAgICBvcy5yZW1vdmUoc2VsZi5iYWNrdXBfZmlsZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIGxvZ2dpbmcuZXJyb3IoZiJDbGVhciBiYWNrdXAgZmFpbGVkOiB7ZX0iKQoKICAgIGRlZiBjaGVja19oYXJkd2FyZV9zdGF0dXMoc2VsZik6CiAgICAgICAgc2VsZi5oYXNfbnZpZGlhX2dwdSA9IEZhbHNlCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdWJwcm9jZXNzLmNoZWNrX291dHB1dCgibnZpZGlhLXNtaSIsIHN0ZGVycj1zdWJwcm9jZXNzLlNURE9VVCwgc2hlbGw9VHJ1ZSkKICAgICAgICAgICAgc2VsZi5oYXNfbnZpZGlhX2dwdSA9IFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzZWxmLmhhc19udmlkaWFfZ3B1ID0gRmFsc2UKCiAgICAgICAgc2VsZi50b3JjaF9jdWRhX2F2YWlsYWJsZSA9IHRvcmNoLmN1ZGEuaXNfYXZhaWxhYmxlKCkKICAgICAgICBzZWxmLmN1ZGFfbWlzc2luZyA9IHNlbGYuaGFzX252aWRpYV9ncHUgYW5kIG5vdCBzZWxmLnRvcmNoX2N1ZGFfYXZhaWxhYmxlCgogICAgZGVmIHNldHVwX2JpbmRpbmdzKHNlbGYpOgogICAgICAgIHNlbGYuYmluZCgiPEYxPiIsIGxhbWJkYSBldmVudDogc2VsZi5zdGFydF9yZWNvcmRpbmcoKSkKICAgICAgICBzZWxmLmJpbmQoIjxGMj4iLCBsYW1iZGEgZXZlbnQ6IHNlbGYudG9nZ2xlX3BhdXNlKCkpCiAgICAgICAgc2VsZi5iaW5kKCI8RjM+IiwgbGFtYmRhIGV2ZW50OiBzZWxmLnN0b3BfcmVjb3JkaW5nKCkpCgogICAgZGVmIHNldHVwX3VpKHNlbGYpOgogICAgICAgIHNlbGYuZ3JpZF9jb2x1bW5jb25maWd1cmUoMCwgd2VpZ2h0PTEpCiAgICAgICAgc2VsZi5ncmlkX3Jvd2NvbmZpZ3VyZSgzLCB3ZWlnaHQ9MSkgCgogICAgICAgICMgLS0tIDEuIEhlYWRlciAtLS0KICAgICAgICBzZWxmLmhlYWRlcl9mcmFtZSA9IGN0ay5DVGtGcmFtZShzZWxmLCBjb3JuZXJfcmFkaXVzPTEwKQogICAgICAgIHNlbGYuaGVhZGVyX2ZyYW1lLmdyaWQocm93PTAsIGNvbHVtbj0wLCBzdGlja3k9ImV3IiwgcGFkeD0yMCwgcGFkeT0oMjAsIDEwKSkKICAgICAgICAKICAgICAgICBzZWxmLnRpdGxlX2xhYmVsID0gY3RrLkNUa0xhYmVsKHNlbGYuaGVhZGVyX2ZyYW1lLCB0ZXh0PWYiTG9jYWwgVHJhbnNjcmliZXIgUHJvIHtBUFBfVkVSU0lPTn0iLCBmb250PSgiUm9ib3RvIE1lZGl1bSIsIDI0KSkKICAgICAgICBzZWxmLnRpdGxlX2xhYmVsLnBhY2socGFkeT0oMTAsIDUpKQogICAgICAgIAogICAgICAgIHNlbGYuZGVzY19sYWJlbCA9IGN0ay5DVGtMYWJlbChzZWxmLmhlYWRlcl9mcmFtZSwgdGV4dD0iU2VjdXJlLCBsb2NhbCBzcGVlY2gtdG8tdGV4dC4gQ29uZmlndXJlIHNldHRpbmdzIGJlbG93LiIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250PSgiUm9ib3RvIiwgMTIpLCB0ZXh0X2NvbG9yPSJncmF5NzAiKQogICAgICAgIHNlbGYuZGVzY19sYWJlbC5wYWNrKHBhZHk9KDAsIDEwKSkKCiAgICAgICAgIyAtLS0gMi4gQ29uZmlndXJhdGlvbiBQYW5lbCAtLS0KICAgICAgICBzZWxmLnNldHRpbmdzX2ZyYW1lID0gY3RrLkNUa0ZyYW1lKHNlbGYpCiAgICAgICAgc2VsZi5zZXR0aW5nc19mcmFtZS5ncmlkKHJvdz0xLCBjb2x1bW49MCwgc3RpY2t5PSJldyIsIHBhZHg9MjAsIHBhZHk9NSkKICAgICAgICAKICAgICAgICAjIE1pY3JvcGhvbmUKICAgICAgICBjdGsuQ1RrTGFiZWwoc2VsZi5zZXR0aW5nc19mcmFtZSwgdGV4dD0iTWljOiIsIGZvbnQ9KCJSb2JvdG8iLCAxNCkpLnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9KDEwLCA1KSwgcGFkeT0xMCkKICAgICAgICBzZWxmLmRldmljZV9jb21ibyA9IGN0ay5DVGtDb21ib0JveChzZWxmLnNldHRpbmdzX2ZyYW1lLCB3aWR0aD0yMjApCiAgICAgICAgc2VsZi5kZXZpY2VfY29tYm8ucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD01LCBwYWR5PTEwKQogICAgICAgIHNlbGYucG9wdWxhdGVfZGV2aWNlcygpCgogICAgICAgICMgTW9kZWwKICAgICAgICBjdGsuQ1RrTGFiZWwoc2VsZi5zZXR0aW5nc19mcmFtZSwgdGV4dD0iTW9kZWw6IiwgZm9udD0oIlJvYm90byIsIDE0KSkucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0oMTAsIDUpLCBwYWR5PTEwKQogICAgICAgIHNlbGYubW9kZWxfY29tYm8gPSBjdGsuQ1RrQ29tYm9Cb3goc2VsZi5zZXR0aW5nc19mcmFtZSwgdmFsdWVzPWxpc3QoTU9ERUxfU0laRVMudmFsdWVzKCkpLCB3aWR0aD0xNDApCiAgICAgICAgc2VsZi5tb2RlbF9jb21iby5zZXQoTU9ERUxfU0laRVNbInNtYWxsIl0pCiAgICAgICAgc2VsZi5tb2RlbF9jb21iby5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PTUsIHBhZHk9MTApCgogICAgICAgICMgQ2h1bmsgU2l6ZSAoU2VnbWVudCkKICAgICAgICBjdGsuQ1RrTGFiZWwoc2VsZi5zZXR0aW5nc19mcmFtZSwgdGV4dD0iQ29udGV4dDoiLCBmb250PSgiUm9ib3RvIiwgMTQpKS5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PSgxMCwgNSksIHBhZHk9MTApCiAgICAgICAgc2VsZi5jaHVua19jb21ibyA9IGN0ay5DVGtDb21ib0JveChzZWxmLnNldHRpbmdzX2ZyYW1lLCB2YWx1ZXM9bGlzdChDSFVOS19PUFRJT05TLmtleXMoKSksIHdpZHRoPTEzMCkKICAgICAgICBzZWxmLmNodW5rX2NvbWJvLnNldCgiMTBzIChCYWxhbmNlZCkiKQogICAgICAgIHNlbGYuY2h1bmtfY29tYm8ucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD01LCBwYWR5PTEwKQoKICAgICAgICAjIFByb2Nlc3NpbmcgVW5pdAogICAgICAgIGN0ay5DVGtMYWJlbChzZWxmLnNldHRpbmdzX2ZyYW1lLCB0ZXh0PSJEZXZpY2U6IiwgZm9udD0oIlJvYm90byIsIDE0KSkucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0oMTAsIDUpLCBwYWR5PTEwKQogICAgICAgIHNlbGYucHJvY19jb21ibyA9IGN0ay5DVGtDb21ib0JveChzZWxmLnNldHRpbmdzX2ZyYW1lLCB2YWx1ZXM9WyJBdXRvIiwgIkdQVSAoQ1VEQSkiLCAiQ1BVIl0sIHdpZHRoPTEwMCwgY29tbWFuZD1zZWxmLm9uX2RldmljZV9jaGFuZ2UpCiAgICAgICAgc2VsZi5wcm9jX2NvbWJvLnNldCgiQXV0byIpCiAgICAgICAgc2VsZi5wcm9jX2NvbWJvLnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9NSwgcGFkeT0xMCkKCiAgICAgICAgaWYgc2VsZi5jdWRhX21pc3Npbmc6CiAgICAgICAgICAgIHNlbGYuZml4X2N1ZGFfYnRuID0gY3RrLkNUa0J1dHRvbihzZWxmLnNldHRpbmdzX2ZyYW1lLCB0ZXh0PSLimqDvuI8gR1BVIiwgZmdfY29sb3I9IiNlNjdlMjIiLCBob3Zlcl9jb2xvcj0iI2QzNTQwMCIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb21tYW5kPXNlbGYub3Blbl9jdWRhX2hlbHAsIHdpZHRoPTYwKQogICAgICAgICAgICBzZWxmLmZpeF9jdWRhX2J0bi5wYWNrKHNpZGU9InJpZ2h0IiwgcGFkeD0xMCkKCiAgICAgICAgIyAtLS0gMy4gTG9hZGluZyBJbmRpY2F0b3IgLS0tCiAgICAgICAgc2VsZi5sb2FkX2ZyYW1lID0gY3RrLkNUa0ZyYW1lKHNlbGYsIGZnX2NvbG9yPSJ0cmFuc3BhcmVudCIpCiAgICAgICAgc2VsZi5sb2FkX2ZyYW1lLmdyaWQocm93PTIsIGNvbHVtbj0wLCBzdGlja3k9ImV3IiwgcGFkeD0yMCwgcGFkeT0oNSwgNSkpCiAgICAgICAgCiAgICAgICAgc2VsZi5sb2FkaW5nX2xhYmVsID0gY3RrLkNUa0xhYmVsKHNlbGYubG9hZF9mcmFtZSwgdGV4dD0iIiwgZm9udD0oIlJvYm90byIsIDExKSwgdGV4dF9jb2xvcj0iZ3JheSIpCiAgICAgICAgc2VsZi5sb2FkaW5nX2xhYmVsLnBhY2socGFkeT0oMCwgMikpCiAgICAgICAgCiAgICAgICAgc2VsZi5wcm9ncmVzc19iYXIgPSBjdGsuQ1RrUHJvZ3Jlc3NCYXIoc2VsZi5sb2FkX2ZyYW1lLCBvcmllbnRhdGlvbj0iaG9yaXpvbnRhbCIsIG1vZGU9ImRldGVybWluYXRlIikKICAgICAgICBzZWxmLnByb2dyZXNzX2Jhci5zZXQoMCkKICAgICAgICBzZWxmLnByb2dyZXNzX2Jhci5wYWNrKGZpbGw9IngiLCBleHBhbmQ9VHJ1ZSkKICAgICAgICBzZWxmLmxvYWRfZnJhbWUuZ3JpZF9yZW1vdmUoKSAKCiAgICAgICAgIyAtLS0gNC4gVHJhbnNjcmlwdCBMb2cgLS0tCiAgICAgICAgc2VsZi50ZXh0Ym94ID0gY3RrLkNUa1RleHRib3goc2VsZiwgZm9udD0oIkNvbnNvbGFzIiwgMTQpLCBjb3JuZXJfcmFkaXVzPTEwKQogICAgICAgIHNlbGYudGV4dGJveC5ncmlkKHJvdz0zLCBjb2x1bW49MCwgc3RpY2t5PSJuc2V3IiwgcGFkeD0yMCwgcGFkeT0xMCkKICAgICAgICBzZWxmLnRleHRib3guaW5zZXJ0KCIwLjAiLCAiLS0tIFRyYW5zY3JpcHQgTG9nIC0tLVxuXG4iKQogICAgICAgIHNlbGYudGV4dGJveC5jb25maWd1cmUoc3RhdGU9ImRpc2FibGVkIikKCiAgICAgICAgIyAtLS0gNS4gQ29udHJvbHMgLS0tCiAgICAgICAgc2VsZi5jb250cm9sc19mcmFtZSA9IGN0ay5DVGtGcmFtZShzZWxmLCBmZ19jb2xvcj0idHJhbnNwYXJlbnQiKQogICAgICAgIHNlbGYuY29udHJvbHNfZnJhbWUuZ3JpZChyb3c9NCwgY29sdW1uPTAsIHN0aWNreT0iZXciLCBwYWR4PTIwLCBwYWR5PSgwLCAyMCkpCgogICAgICAgIHNlbGYuaG90a2V5X2xhYmVsID0gY3RrLkNUa0xhYmVsKHNlbGYuY29udHJvbHNfZnJhbWUsIHRleHQ9IkhvdGtleXM6IFtGMV0gUmVjb3JkICB8ICBbRjJdIFBhdXNlICB8ICBbRjNdIFN0b3AiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb250PSgiQ29uc29sYXMiLCAxMSksIHRleHRfY29sb3I9ImdyYXkiKQogICAgICAgIHNlbGYuaG90a2V5X2xhYmVsLnBhY2soc2lkZT0idG9wIiwgcGFkeT0oMCwgNSkpCgogICAgICAgIHNlbGYuYnRuX2lubmVyID0gY3RrLkNUa0ZyYW1lKHNlbGYuY29udHJvbHNfZnJhbWUsIGZnX2NvbG9yPSJ0cmFuc3BhcmVudCIpCiAgICAgICAgc2VsZi5idG5faW5uZXIucGFjaygpCgogICAgICAgIHNlbGYucmVjb3JkX2J0biA9IGN0ay5DVGtCdXR0b24oc2VsZi5idG5faW5uZXIsIHRleHQ9IuKXjyBSZWNvcmQiLCBmZ19jb2xvcj0iI2Q2MzAzMSIsIGhvdmVyX2NvbG9yPSIjZmY3Njc1Iiwgd2lkdGg9MTQwLCBoZWlnaHQ9NDAsIGZvbnQ9KCJSb2JvdG8iLCAxNiwgImJvbGQiKSwgY29tbWFuZD1zZWxmLnN0YXJ0X3JlY29yZGluZykKICAgICAgICBzZWxmLnJlY29yZF9idG4ucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0xNSkKCiAgICAgICAgc2VsZi5wYXVzZV9idG4gPSBjdGsuQ1RrQnV0dG9uKHNlbGYuYnRuX2lubmVyLCB0ZXh0PSLinZrinZogUGF1c2UiLCBmZ19jb2xvcj0iI2UxNzA1NSIsIGhvdmVyX2NvbG9yPSIjZmFiMWEwIiwgd2lkdGg9MTQwLCBoZWlnaHQ9NDAsIGZvbnQ9KCJSb2JvdG8iLCAxNiwgImJvbGQiKSwgc3RhdGU9ImRpc2FibGVkIiwgY29tbWFuZD1zZWxmLnRvZ2dsZV9wYXVzZSkKICAgICAgICBzZWxmLnBhdXNlX2J0bi5wYWNrKHNpZGU9ImxlZnQiLCBwYWR4PTE1KQoKICAgICAgICBzZWxmLnN0b3BfYnRuID0gY3RrLkNUa0J1dHRvbihzZWxmLmJ0bl9pbm5lciwgdGV4dD0i4pagIFN0b3AiLCBmZ19jb2xvcj0iIzYzNmU3MiIsIGhvdmVyX2NvbG9yPSIjYjJiZWMzIiwgd2lkdGg9MTQwLCBoZWlnaHQ9NDAsIGZvbnQ9KCJSb2JvdG8iLCAxNiwgImJvbGQiKSwgc3RhdGU9ImRpc2FibGVkIiwgY29tbWFuZD1zZWxmLnN0b3BfcmVjb3JkaW5nKQogICAgICAgIHNlbGYuc3RvcF9idG4ucGFjayhzaWRlPSJsZWZ0IiwgcGFkeD0xNSkKCiAgICAgICAgIyBTYXZlIE1vZGUgTWVudQogICAgICAgIHNlbGYuc2F2ZV9tb2RlX3ZhciA9IGN0ay5TdHJpbmdWYXIodmFsdWU9IlNhdmU6IERlc2t0b3AiKQogICAgICAgIHNlbGYuc2F2ZV9tb2RlX21lbnUgPSBjdGsuQ1RrT3B0aW9uTWVudShzZWxmLmJ0bl9pbm5lciwgdmFsdWVzPVsiU2F2ZTogRGVza3RvcCIsICJTYXZlOiBDdXN0b20uLi4iLCAiU2F2ZTogQXNrIl0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbW1hbmQ9c2VsZi5vbl9zYXZlX21vZGVfY2hhbmdlLCB3aWR0aD0xNDAsIGhlaWdodD00MCwgZm9udD0oIlJvYm90byIsIDE0KSkKICAgICAgICBzZWxmLnNhdmVfbW9kZV9tZW51LnBhY2soc2lkZT0ibGVmdCIsIHBhZHg9MTUpCiAgICAgICAgc2VsZi5jdXN0b21fc2F2ZV9wYXRoID0gIiIKCiAgICAgICAgc2VsZi5zdGF0dXNfYmFyID0gY3RrLkNUa0xhYmVsKHNlbGYsIHRleHQ9IlJlYWR5IChBdXRvc2F2ZTogRGVza3RvcCkiLCBhbmNob3I9ImUiLCB0ZXh0X2NvbG9yPSJncmF5IikKICAgICAgICBzZWxmLnN0YXR1c19iYXIuZ3JpZChyb3c9NSwgY29sdW1uPTAsIHN0aWNreT0iZXciLCBwYWR4PTI1LCBwYWR5PSgwLCAxMCkpCgogICAgZGVmIG9uX3NhdmVfbW9kZV9jaGFuZ2Uoc2VsZiwgY2hvaWNlKToKICAgICAgICBpZiBjaG9pY2UgPT0gIlNhdmU6IEN1c3RvbS4uLiI6CiAgICAgICAgICAgIHBhdGggPSBmaWxlZGlhbG9nLmFza2RpcmVjdG9yeSh0aXRsZT0iU2VsZWN0IEF1dG8tU2F2ZSBGb2xkZXIiKQogICAgICAgICAgICBpZiBwYXRoOgogICAgICAgICAgICAgICAgc2VsZi5jdXN0b21fc2F2ZV9wYXRoID0gcGF0aAogICAgICAgICAgICAgICAgc2VsZi5sb2dfbWVzc2FnZShmIltTeXN0ZW1dIEF1dG8tc2F2ZSBmb2xkZXIgc2V0IHRvOiB7cGF0aH0iKQogICAgICAgICAgICAgICAgc2VsZi5zdGF0dXNfYmFyLmNvbmZpZ3VyZSh0ZXh0PWYiUmVhZHkgKEF1dG9zYXZlOiB7b3MucGF0aC5iYXNlbmFtZShwYXRoKX0pIikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuc2F2ZV9tb2RlX21lbnUuc2V0KCJTYXZlOiBEZXNrdG9wIikgIyBSZXZlcnQgaWYgY2FuY2VsbGVkCiAgICAgICAgICAgICAgICBzZWxmLnN0YXR1c19iYXIuY29uZmlndXJlKHRleHQ9IlJlYWR5IChBdXRvc2F2ZTogRGVza3RvcCkiKQogICAgICAgIGVsaWYgY2hvaWNlID09ICJTYXZlOiBEZXNrdG9wIjoKICAgICAgICAgICAgc2VsZi5zdGF0dXNfYmFyLmNvbmZpZ3VyZSh0ZXh0PSJSZWFkeSAoQXV0b3NhdmU6IERlc2t0b3ApIikKICAgICAgICBlbHNlOiAjIFNhdmU6IEFzawogICAgICAgICAgICBzZWxmLnN0YXR1c19iYXIuY29uZmlndXJlKHRleHQ9IlJlYWR5IChBc2sgb24gU3RvcCkiKQoKICAgIGRlZiBvbl9kZXZpY2VfY2hhbmdlKHNlbGYsIGNob2ljZSk6CiAgICAgICAgaWYgY2hvaWNlID09ICJHUFUgKENVREEpIiBhbmQgbm90IHNlbGYudG9yY2hfY3VkYV9hdmFpbGFibGU6CiAgICAgICAgICAgIG1lc3NhZ2Vib3guc2hvd3dhcm5pbmcoIkhhcmR3YXJlIFdhcm5pbmciLCAiQ1VEQSBpcyBub3QgYXZhaWxhYmxlIG9uIHRoaXMgc3lzdGVtLlxuUnVubmluZyBpbiBDUFUgbW9kZSBpbnN0ZWFkLiIpCiAgICAgICAgICAgIHNlbGYucHJvY19jb21iby5zZXQoIkNQVSIpCgogICAgZGVmIG9wZW5fY3VkYV9oZWxwKHNlbGYpOgogICAgICAgIHdlYmJyb3dzZXIub3BlbigiaHR0cHM6Ly9kZXZlbG9wZXIubnZpZGlhLmNvbS9jdWRhLWRvd25sb2FkcyIpCgogICAgZGVmIHBvcHVsYXRlX2RldmljZXMoc2VsZik6CiAgICAgICAgZGV2aWNlcyA9IHNkLnF1ZXJ5X2RldmljZXMoKQogICAgICAgIGlucHV0X2RldmljZXMgPSBbXQogICAgICAgIGRlZmF1bHRfaWR4ID0gc2QuZGVmYXVsdC5kZXZpY2VbMF0KICAgICAgICBkZWZhdWx0X3NlbGVjdGlvbiA9IE5vbmUKICAgICAgICAKICAgICAgICBmb3IgaSwgZCBpbiBlbnVtZXJhdGUoZGV2aWNlcyk6CiAgICAgICAgICAgIGlmIGRbJ21heF9pbnB1dF9jaGFubmVscyddID4gMDoKICAgICAgICAgICAgICAgIG5hbWUgPSBmIntpfToge2RbJ25hbWUnXX0iCiAgICAgICAgICAgICAgICBpbnB1dF9kZXZpY2VzLmFwcGVuZChuYW1lKQogICAgICAgICAgICAgICAgaWYgaSA9PSBkZWZhdWx0X2lkeDoKICAgICAgICAgICAgICAgICAgICBkZWZhdWx0X3NlbGVjdGlvbiA9IG5hbWUKICAgICAgICAgICAgICAgICAgICAKICAgICAgICBzZWxmLmRldmljZV9jb21iby5jb25maWd1cmUodmFsdWVzPWlucHV0X2RldmljZXMpCiAgICAgICAgaWYgZGVmYXVsdF9zZWxlY3Rpb246CiAgICAgICAgICAgIHNlbGYuZGV2aWNlX2NvbWJvLnNldChkZWZhdWx0X3NlbGVjdGlvbikKICAgICAgICBlbGlmIGlucHV0X2RldmljZXM6CiAgICAgICAgICAgIHNlbGYuZGV2aWNlX2NvbWJvLnNldChpbnB1dF9kZXZpY2VzWzBdKQoKICAgIGRlZiBsb2dfbWVzc2FnZShzZWxmLCBtZXNzYWdlKToKICAgICAgICBzZWxmLnRleHRib3guY29uZmlndXJlKHN0YXRlPSJub3JtYWwiKQogICAgICAgIHNlbGYudGV4dGJveC5pbnNlcnQoImVuZCIsIG1lc3NhZ2UgKyAiXG4iKQogICAgICAgIHNlbGYudGV4dGJveC5zZWUoImVuZCIpCiAgICAgICAgc2VsZi50ZXh0Ym94LmNvbmZpZ3VyZShzdGF0ZT0iZGlzYWJsZWQiKQoKICAgIGRlZiB1cGRhdGVfcHJvZ3Jlc3Moc2VsZiwgdmFsKToKICAgICAgICBzZWxmLmFmdGVyKDAsIGxhbWJkYTogc2VsZi5fdXBkYXRlX3Byb2dyZXNzX2d1aSh2YWwpKQoKICAgIGRlZiBfdXBkYXRlX3Byb2dyZXNzX2d1aShzZWxmLCB2YWwpOgogICAgICAgIHNlbGYucHJvZ3Jlc3NfYmFyLnNldCh2YWwpCiAgICAgICAgc2VsZi5sb2FkaW5nX2xhYmVsLmNvbmZpZ3VyZSh0ZXh0PWYiRG93bmxvYWRpbmcgTW9kZWwuLi4ge2ludCh2YWwqMTAwKX0lIikKCiAgICBkZWYgc3RhcnRfcmVjb3JkaW5nKHNlbGYpOgogICAgICAgIGlmIHNlbGYuaXNfbG9hZGluZ19tb2RlbDogcmV0dXJuCiAgICAgICAgc2VsZWN0ZWRfZGV2aWNlX3N0ciA9IHNlbGYuZGV2aWNlX2NvbWJvLmdldCgpCiAgICAgICAgaWYgbm90IHNlbGVjdGVkX2RldmljZV9zdHI6CiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2Jhci5jb25maWd1cmUodGV4dD0iRXJyb3I6IE5vIG1pY3JvcGhvbmUgc2VsZWN0ZWQiKQogICAgICAgICAgICByZXR1cm4KICAgICAgICAKICAgICAgICBkZXZpY2VfaW5kZXggPSBpbnQoc2VsZWN0ZWRfZGV2aWNlX3N0ci5zcGxpdCgiOiIpWzBdKQogICAgICAgIG1vZGVsX2Rpc3BsYXlfbmFtZSA9IHNlbGYubW9kZWxfY29tYm8uZ2V0KCkKICAgICAgICBtb2RlbF9uYW1lID0gUkVWRVJTRV9NT0RFTF9NQVAuZ2V0KG1vZGVsX2Rpc3BsYXlfbmFtZSwgInNtYWxsIikKICAgICAgICAKICAgICAgICBjaHVua19kaXNwbGF5ID0gc2VsZi5jaHVua19jb21iby5nZXQoKQogICAgICAgIGNodW5rX2R1cmF0aW9uID0gQ0hVTktfT1BUSU9OUy5nZXQoY2h1bmtfZGlzcGxheSwgMTApCgogICAgICAgIHByb2NfbW9kZSA9IHNlbGYucHJvY19jb21iby5nZXQoKQoKICAgICAgICBzZWxmLnJlY29yZF9idG4uY29uZmlndXJlKHN0YXRlPSJkaXNhYmxlZCIsIGZnX2NvbG9yPSIjNTU1NTU1IikKICAgICAgICBzZWxmLmRldmljZV9jb21iby5jb25maWd1cmUoc3RhdGU9ImRpc2FibGVkIikKICAgICAgICBzZWxmLm1vZGVsX2NvbWJvLmNvbmZpZ3VyZShzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgIHNlbGYuY2h1bmtfY29tYm8uY29uZmlndXJlKHN0YXRlPSJkaXNhYmxlZCIpCiAgICAgICAgc2VsZi5wcm9jX2NvbWJvLmNvbmZpZ3VyZShzdGF0ZT0iZGlzYWJsZWQiKQogICAgICAgIHNlbGYuc2F2ZV9tb2RlX21lbnUuY29uZmlndXJlKHN0YXRlPSJkaXNhYmxlZCIpCiAgICAgICAgCiAgICAgICAgc2VsZi5sb2FkX2ZyYW1lLmdyaWQoKQogICAgICAgIHNlbGYucHJvZ3Jlc3NfYmFyLnNldCgwKQogICAgICAgIHNlbGYubG9hZGluZ19sYWJlbC5jb25maWd1cmUodGV4dD0iSW5pdGlhbGl6aW5nLi4uIikKICAgICAgICAKICAgICAgICB0aHJlYWRpbmcuVGhyZWFkKHRhcmdldD1zZWxmLmluaXRfYW5kX3JlY29yZCwgYXJncz0oZGV2aWNlX2luZGV4LCBtb2RlbF9uYW1lLCBwcm9jX21vZGUsIGNodW5rX2R1cmF0aW9uKSwgZGFlbW9uPVRydWUpLnN0YXJ0KCkKCiAgICBkZWYgaW5pdF9hbmRfcmVjb3JkKHNlbGYsIGRldmljZV9pbmRleCwgbW9kZWxfbmFtZSwgcHJvY19tb2RlLCBjaHVua19kdXJhdGlvbik6CiAgICAgICAgc2VsZi5pc19sb2FkaW5nX21vZGVsID0gVHJ1ZQogICAgICAgIHNlbGYucmVkaXJlY3RvciA9IFN0ZEVyclJlZGlyZWN0b3Ioc2VsZi51cGRhdGVfcHJvZ3Jlc3MpCiAgICAgICAgc2VsZi5yZWRpcmVjdG9yLnN0YXJ0KCkKICAgICAgICAKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRldmljZV9zdHIgPSAiY3B1IgogICAgICAgICAgICBpZiBwcm9jX21vZGUgPT0gIkdQVSAoQ1VEQSkiOgogICAgICAgICAgICAgICAgZGV2aWNlX3N0ciA9ICJjdWRhIgogICAgICAgICAgICBlbGlmIHByb2NfbW9kZSA9PSAiQXV0byI6CiAgICAgICAgICAgICAgICBkZXZpY2Vfc3RyID0gImN1ZGEiIGlmIHRvcmNoLmN1ZGEuaXNfYXZhaWxhYmxlKCkgZWxzZSAiY3B1IgogICAgICAgICAgICAKICAgICAgICAgICAgaWYgc2VsZi5tb2RlbCBpcyBOb25lIG9yIHNlbGYubW9kZWxfbmFtZSAhPSBtb2RlbF9uYW1lOgogICAgICAgICAgICAgICAgc2VsZi5hZnRlcigwLCBsYW1iZGE6IHNlbGYubG9hZGluZ19sYWJlbC5jb25maWd1cmUodGV4dD1mIkxvYWRpbmcge21vZGVsX25hbWV9IG9uIHtkZXZpY2Vfc3RyLnVwcGVyKCl9Li4uIikpCiAgICAgICAgICAgICAgICBzZWxmLmxvZ19tZXNzYWdlKGYiW1N5c3RlbV0gTG9hZGluZyBXaGlzcGVyIG1vZGVsICd7bW9kZWxfbmFtZX0nIG9uIHtkZXZpY2Vfc3RyLnVwcGVyKCl9Li4uIikKICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgc2VsZi5tb2RlbCA9IHdoaXNwZXIubG9hZF9tb2RlbChtb2RlbF9uYW1lLCBkZXZpY2U9ZGV2aWNlX3N0cikKICAgICAgICAgICAgICAgIHNlbGYubW9kZWxfbmFtZSA9IG1vZGVsX25hbWUKICAgICAgICAgICAgICAgIHNlbGYubG9nX21lc3NhZ2UoIltTeXN0ZW1dIE1vZGVsIGxvYWRlZCBzdWNjZXNzZnVsbHkuIikKCiAgICAgICAgICAgIHNlbGYuc2Vzc2lvbl9zdGFydF90aW1lID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkKICAgICAgICAgICAgaWYgbm90IHNlbGYuZnVsbF90cmFuc2NyaXB0OgogICAgICAgICAgICAgICAgc2VsZi5mdWxsX3RyYW5zY3JpcHQgPSBbXQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi5yZWNvcmRlci5zdGFydChkZXZpY2VfaW5kZXgsIGNodW5rX2R1cmF0aW9uKQogICAgICAgICAgICBzZWxmLmFmdGVyKDAsIHNlbGYudXBkYXRlX3VpX3JlY29yZGluZ19zdGFydGVkKQogICAgICAgICAgICAKICAgICAgICAgICAgc2VsZi50cmFuc2NyaXB0aW9uX3RocmVhZCA9IHRocmVhZGluZy5UaHJlYWQodGFyZ2V0PXNlbGYucHJvY2Vzc19hdWRpb19xdWV1ZSwgZGFlbW9uPVRydWUpCiAgICAgICAgICAgIHNlbGYudHJhbnNjcmlwdGlvbl90aHJlYWQuc3RhcnQoKQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIG1zZyA9IGYiW0Vycm9yXSBGYWlsZWQgdG8gc3RhcnQ6IHtzdHIoZSl9IgogICAgICAgICAgICBzZWxmLmxvZ19tZXNzYWdlKG1zZykKICAgICAgICAgICAgbG9nZ2luZy5lcnJvcihtc2cpCiAgICAgICAgICAgIHNlbGYuYWZ0ZXIoMCwgc2VsZi5yZXNldF91aSkKICAgICAgICBmaW5hbGx5OgogICAgICAgICAgICBpZiBzZWxmLnJlZGlyZWN0b3I6CiAgICAgICAgICAgICAgICBzZWxmLnJlZGlyZWN0b3Iuc3RvcCgpCiAgICAgICAgICAgIHNlbGYuaXNfbG9hZGluZ19tb2RlbCA9IEZhbHNlCiAgICAgICAgICAgIHNlbGYuYWZ0ZXIoMCwgbGFtYmRhOiBzZWxmLmxvYWRfZnJhbWUuZ3JpZF9yZW1vdmUoKSkKCiAgICBkZWYgdXBkYXRlX3VpX3JlY29yZGluZ19zdGFydGVkKHNlbGYpOgogICAgICAgIHNlbGYucGF1c2VfYnRuLmNvbmZpZ3VyZShzdGF0ZT0ibm9ybWFsIiwgZmdfY29sb3I9IiNlMTcwNTUiKQogICAgICAgIHNlbGYuc3RvcF9idG4uY29uZmlndXJlKHN0YXRlPSJub3JtYWwiLCBmZ19jb2xvcj0iI2Q2MzAzMSIpCiAgICAgICAgc2VsZi5zdGF0dXNfYmFyLmNvbmZpZ3VyZSh0ZXh0PSLil48gUmVjb3JkaW5nIGluIHByb2dyZXNzLi4uIikKICAgICAgICBzZWxmLmxvZ19tZXNzYWdlKGYiXG4+Pj4gU2Vzc2lvbiBTdGFydGVkOiB7c2VsZi5zZXNzaW9uX3N0YXJ0X3RpbWUuc3RyZnRpbWUoJyVIOiVNOiVTJyl9IikKCiAgICBkZWYgdG9nZ2xlX3BhdXNlKHNlbGYpOgogICAgICAgIGlmIHNlbGYucmVjb3JkZXIucGF1c2VkOgogICAgICAgICAgICBzZWxmLnJlY29yZGVyLnJlc3VtZSgpCiAgICAgICAgICAgIHNlbGYucGF1c2VfYnRuLmNvbmZpZ3VyZSh0ZXh0PSLinZrinZogUGF1c2UiLCBmZ19jb2xvcj0iI2UxNzA1NSIpCiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2Jhci5jb25maWd1cmUodGV4dD0i4pePIFJlY29yZGluZy4uLiIpCiAgICAgICAgICAgIHNlbGYubG9nX21lc3NhZ2UoIltTeXN0ZW1dIFJlc3VtZWQuIikKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnJlY29yZGVyLnBhdXNlKCkKICAgICAgICAgICAgc2VsZi5wYXVzZV9idG4uY29uZmlndXJlKHRleHQ9IuKWtiBSZXN1bWUiLCBmZ19jb2xvcj0iIzAwYjg5NCIpCiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2Jhci5jb25maWd1cmUodGV4dD0i4p2a4p2aIFBhdXNlZCIpCiAgICAgICAgICAgIHNlbGYubG9nX21lc3NhZ2UoIltTeXN0ZW1dIFBhdXNlZC4iKQoKICAgIGRlZiBzdG9wX3JlY29yZGluZyhzZWxmKToKICAgICAgICBzZWxmLnJlY29yZGVyLnN0b3AoKQogICAgICAgIHNlbGYuc3RhdHVzX2Jhci5jb25maWd1cmUodGV4dD0iU3RvcHBpbmcgJiBGaW5hbGl6aW5nLi4uIikKICAgICAgICBzZWxmLnJlY29yZGVyLmF1ZGlvX3F1ZXVlLnB1dChOb25lKSAKCiAgICBkZWYgcHJvY2Vzc19hdWRpb19xdWV1ZShzZWxmKToKICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICBhdWRpb19kYXRhID0gc2VsZi5yZWNvcmRlci5hdWRpb19xdWV1ZS5nZXQoKQogICAgICAgICAgICBpZiBhdWRpb19kYXRhIGlzIE5vbmU6IGJyZWFrCiAgICAgICAgICAgIAogICAgICAgICAgICBmbGF0dGVuZWRfYXVkaW8gPSBhdWRpb19kYXRhLmZsYXR0ZW4oKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcDE2X3ZhbCA9IChzZWxmLm1vZGVsLmRldmljZS50eXBlID09ICJjdWRhIikKICAgICAgICAgICAgICAgIHJlc3VsdCA9IHNlbGYubW9kZWwudHJhbnNjcmliZShmbGF0dGVuZWRfYXVkaW8sIGZwMTY9ZnAxNl92YWwpIAogICAgICAgICAgICAgICAgdGV4dCA9IHJlc3VsdFsidGV4dCJdLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIHRleHQ6CiAgICAgICAgICAgICAgICAgICAgdGltZXN0YW1wID0gZGF0ZXRpbWUuZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgICAgICAgICAgICAgICBsaW5lID0gZiJbe3RpbWVzdGFtcH1dIHt0ZXh0fSIKICAgICAgICAgICAgICAgICAgICBzZWxmLmZ1bGxfdHJhbnNjcmlwdC5hcHBlbmQobGluZSkKICAgICAgICAgICAgICAgICAgICBzZWxmLmFwcGVuZF90b19iYWNrdXAobGluZSkgIyBBdXRvLUJhY2t1cCBpbW1lZGlhdGVseQogICAgICAgICAgICAgICAgICAgIHNlbGYuYWZ0ZXIoMCwgbGFtYmRhIHQ9bGluZTogc2VsZi5sb2dfbWVzc2FnZSh0KSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICAgICAgbG9nZ2luZy5lcnJvcihmIlRyYW5zY3JpcHRpb24gZXJyb3I6IHtlfSIpCgogICAgICAgIHNlbGYuYWZ0ZXIoMCwgc2VsZi5wZXJmb3JtX3NhdmUpCiAgICAgICAgc2VsZi5hZnRlcigwLCBzZWxmLnJlc2V0X3VpKQoKICAgIGRlZiBwZXJmb3JtX3NhdmUoc2VsZik6CiAgICAgICAgaWYgbm90IHNlbGYuZnVsbF90cmFuc2NyaXB0OgogICAgICAgICAgICBzZWxmLmxvZ19tZXNzYWdlKCJbU3lzdGVtXSBObyB0ZXh0IHJlY29yZGVkLiIpCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBtb2RlID0gc2VsZi5zYXZlX21vZGVfbWVudS5nZXQoKQogICAgICAgIGZpbGVuYW1lID0gZiJUcmFuc2NyaXB0X3tzZWxmLnNlc3Npb25fc3RhcnRfdGltZS5zdHJmdGltZSgnJVktJW0tJWRfJUgtJU0tJVMnKX0udHh0IgogICAgICAgIGZpbGVwYXRoID0gTm9uZQoKICAgICAgICBpZiBtb2RlID09ICJTYXZlOiBBc2siOgogICAgICAgICAgICBkZWZhdWx0X25hbWUgPSBmIlRyYW5zY3JpcHRfe3NlbGYuc2Vzc2lvbl9zdGFydF90aW1lLnN0cmZ0aW1lKCclWS0lbS0lZF8lSC0lTS0lUycpfSIKICAgICAgICAgICAgZmlsZXBhdGggPSBmaWxlZGlhbG9nLmFza3NhdmVhc2ZpbGVuYW1lKAogICAgICAgICAgICAgICAgZGVmYXVsdGV4dGVuc2lvbj0iLnR4dCIsCiAgICAgICAgICAgICAgICBpbml0aWFsZmlsZT1kZWZhdWx0X25hbWUsCiAgICAgICAgICAgICAgICBmaWxldHlwZXM9WygiVGV4dCBEb2N1bWVudHMiLCAiKi50eHQiKSwgKCJBbGwgRmlsZXMiLCAiKi4qIildLAogICAgICAgICAgICAgICAgdGl0bGU9IlNhdmUgVHJhbnNjcmlwdCBBcyIKICAgICAgICAgICAgKQogICAgICAgIGVsaWYgbW9kZSA9PSAiU2F2ZTogQ3VzdG9tLi4uIiBhbmQgc2VsZi5jdXN0b21fc2F2ZV9wYXRoOgogICAgICAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oc2VsZi5jdXN0b21fc2F2ZV9wYXRoLCBmaWxlbmFtZSkKICAgICAgICBlbHNlOiAjIFNhdmU6IERlc2t0b3AgKERlZmF1bHQpCiAgICAgICAgICAgICBkZXNrdG9wID0gb3MucGF0aC5qb2luKG9zLnBhdGguam9pbihvcy5lbnZpcm9uWydVU0VSUFJPRklMRSddKSwgJ0Rlc2t0b3AnKQogICAgICAgICAgICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oZGVza3RvcCwgZmlsZW5hbWUpCgogICAgICAgIGlmIGZpbGVwYXRoOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZmlsZXBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgICAgICBmLndyaXRlKGYiVFJBTlNDUklQVCBTRVNTSU9OXG5EYXRlOiB7c2VsZi5zZXNzaW9uX3N0YXJ0X3RpbWV9XG5Nb2RlbDoge3NlbGYubW9kZWxfbmFtZX1cbiIpCiAgICAgICAgICAgICAgICAgICAgZi53cml0ZSgiPSIgKiA2MCArICJcblxuIikKICAgICAgICAgICAgICAgICAgICBmLndyaXRlKCJcbiIuam9pbihzZWxmLmZ1bGxfdHJhbnNjcmlwdCkpCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIHNlbGYubG9nX21lc3NhZ2UoZiJcbltTeXN0ZW1dIOKclCBTYXZlZCB0bzpcbntmaWxlcGF0aH0iKQogICAgICAgICAgICAgICAgc2VsZi5mdWxsX3RyYW5zY3JpcHQgPSBbXSAjIENsZWFyIG9ubHkgYWZ0ZXIgc3VjY2Vzc2Z1bCBzYXZlCiAgICAgICAgICAgICAgICBzZWxmLmNsZWFyX2JhY2t1cCgpICMgQ2xlYW4gdXAgdGhlIGJhY2t1cCBmaWxlCiAgICAgICAgICAgICAgICBzZWxmLmxvZ19tZXNzYWdlKCJbU3lzdGVtXSBCYWNrdXAgZmlsZSBjbGVhcmVkLiIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHNlbGYubG9nX21lc3NhZ2UoZiJbRXJyb3JdIENvdWxkIG5vdCBzYXZlIGZpbGU6IHtlfSIpCiAgICAgICAgICAgICAgICBtZXNzYWdlYm94LnNob3dlcnJvcigiU2F2ZSBFcnJvciIsIGYiQ291bGQgbm90IHNhdmUgZmlsZTpcbntlfSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5sb2dfbWVzc2FnZSgiW1N5c3RlbV0gU2F2ZSBjYW5jZWxsZWQuIFRleHQgcmV0YWluZWQgaW4gYmFja3VwLiIpCgogICAgZGVmIHJlc2V0X3VpKHNlbGYpOgogICAgICAgIHNlbGYucmVjb3JkX2J0bi5jb25maWd1cmUoc3RhdGU9Im5vcm1hbCIsIGZnX2NvbG9yPSIjZDYzMDMxIikKICAgICAgICBzZWxmLnBhdXNlX2J0bi5jb25maWd1cmUoc3RhdGU9ImRpc2FibGVkIiwgdGV4dD0i4p2a4p2aIFBhdXNlIiwgZmdfY29sb3I9IiNlMTcwNTUiKQogICAgICAgIHNlbGYuc3RvcF9idG4uY29uZmlndXJlKHN0YXRlPSJkaXNhYmxlZCIsIGZnX2NvbG9yPSIjNjM2ZTcyIikKICAgICAgICBzZWxmLmRldmljZV9jb21iby5jb25maWd1cmUoc3RhdGU9Im5vcm1hbCIpCiAgICAgICAgc2VsZi5tb2RlbF9jb21iby5jb25maWd1cmUoc3RhdGU9Im5vcm1hbCIpCiAgICAgICAgc2VsZi5jaHVua19jb21iby5jb25maWd1cmUoc3RhdGU9Im5vcm1hbCIpCiAgICAgICAgc2VsZi5wcm9jX2NvbWJvLmNvbmZpZ3VyZShzdGF0ZT0ibm9ybWFsIikKICAgICAgICBzZWxmLnNhdmVfbW9kZV9tZW51LmNvbmZpZ3VyZShzdGF0ZT0ibm9ybWFsIikKICAgICAgICAKICAgICAgICAjIFJlc3RvcmUgc3RhdHVzIGJhciB0byBzaG93IGN1cnJlbnQgc2F2ZSBtb2RlCiAgICAgICAgbW9kZSA9IHNlbGYuc2F2ZV9tb2RlX21lbnUuZ2V0KCkKICAgICAgICBpZiBtb2RlID09ICJTYXZlOiBEZXNrdG9wIjoKICAgICAgICAgICAgIHNlbGYuc3RhdHVzX2Jhci5jb25maWd1cmUodGV4dD0iUmVhZHkgKEF1dG9zYXZlOiBEZXNrdG9wKSIpCiAgICAgICAgZWxpZiBtb2RlID09ICJTYXZlOiBDdXN0b20uLi4iIGFuZCBzZWxmLmN1c3RvbV9zYXZlX3BhdGg6CiAgICAgICAgICAgICBzZWxmLnN0YXR1c19iYXIuY29uZmlndXJlKHRleHQ9ZiJSZWFkeSAoQXV0b3NhdmU6IHtvcy5wYXRoLmJhc2VuYW1lKHNlbGYuY3VzdG9tX3NhdmVfcGF0aCl9KSIpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgIHNlbGYuc3RhdHVzX2Jhci5jb25maWd1cmUodGV4dD0iUmVhZHkgKEFzayBvbiBTdG9wKSIpCgogICAgZGVmIG9uX2Nsb3NlKHNlbGYpOgogICAgICAgIHNlbGYucnVubmluZyA9IEZhbHNlCiAgICAgICAgaWYgc2VsZi5yZWNvcmRlci5yZWNvcmRpbmc6CiAgICAgICAgICAgIHNlbGYucmVjb3JkZXIuc3RvcCgpCiAgICAgICAgc2VsZi5kZXN0cm95KCkKICAgICAgICBzeXMuZXhpdCgpCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgYXBwID0gVHJhbnNjcmliZXJBcHAoKQogICAgYXBwLm1haW5sb29wKCk="

# Setup Paths
APP_DIR = os.path.dirname(os.path.abspath(sys.argv[0]))
if getattr(sys, 'frozen', False):
    APP_DIR = os.path.dirname(sys.executable)

VENV_DIR = os.path.join(APP_DIR, "transcriber_env")
APP_FILE = os.path.join(APP_DIR, "local_transcriber.py")
LOG_FILE = os.path.join(APP_DIR, "installer_debug.log")

# Setup Logging
try:
    with open(LOG_FILE, "w", encoding="utf-8") as f:
        f.write(f"Installer Log Started: {datetime.datetime.now()}\n")
except: pass

def log_msg(msg):
    # Log to file
    try:
        with open(LOG_FILE, "a", encoding="utf-8") as f:
            f.write(f"{datetime.datetime.now()} - {msg}\n")
    except: pass
    
    # Log to UI
    try:
        log_text.configure(state="normal")
        log_text.insert("end", str(msg) + "\n")
        log_text.see("end")
        log_text.configure(state="disabled")
        root.update_idletasks()
    except: pass

def run_command(cmd):
    log_msg(f"Running: {' '.join(cmd)}")
    try:
        process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True)
        for line in process.stdout:
            log_msg(line.strip())
        process.wait()
    except Exception as e:
        log_msg(f"Command failed: {e}")

def get_compatible_python():
    # 1. Try py launcher
    for ver in ["-3.12", "-3.11", "-3.10"]:
        try:
            cmd = ["py", ver, "-c", "import sys; print(sys.executable)"]
            res = subprocess.run(cmd, capture_output=True, text=True)
            if res.returncode == 0:
                path = res.stdout.strip()
                log_msg(f"Found Python {ver}: {path}")
                return path
        except: pass

    # 2. Try default python
    try:
        cmd = ["python", "-c", "import sys; print(sys.version_info[:2]); print(sys.executable)"]
        res = subprocess.run(cmd, capture_output=True, text=True)
        if res.returncode == 0:
            lines = res.stdout.strip().split('\n')
            ver = eval(lines[0])
            path = lines[1]
            if (3, 10) <= ver <= (3, 12):
                log_msg(f"Default Python {ver} is compatible.")
                return path
    except: pass
    
    return None

def installer_logic():
    progress.start(10)
    
    # 1. Find Python
    lbl_status.config(text="Searching for Python...")
    sys_python = get_compatible_python()
    if not sys_python:
        progress.stop()
        messagebox.showerror("Error", "Python 3.10, 3.11, or 3.12 not found.\nPlease install Python 3.12 from python.org")
        root.quit()
        return

    # 2. Extract App
    lbl_status.config(text="Extracting App...")
    try:
        code = base64.b64decode(APP_CODE_B64).decode('utf-8')
        with open(APP_FILE, "w", encoding="utf-8") as f:
            f.write(code)
        log_msg("App extracted.")
    except Exception as e:
        log_msg(f"Extraction failed: {e}")
        return

    # 3. Venv
    venv_python = os.path.join(VENV_DIR, "Scripts", "python.exe")
    if not os.path.exists(venv_python):
        lbl_status.config(text="Creating Virtual Environment...")
        try:
            subprocess.check_call([sys_python, "-m", "venv", VENV_DIR])
            log_msg("Venv created.")
        except Exception as e:
            log_msg(f"Venv creation failed: {e}")
            return

    # 4. Install
    lbl_status.config(text="Installing Dependencies...")
    
    # Upgrade Pip
    subprocess.call([venv_python, "-m", "pip", "install", "--upgrade", "pip", "--no-cache-dir"])
    
    # Install Torch (CUDA)
    lbl_status.config(text="Downloading AI Engine (2GB+)...")
    run_command([venv_python, "-m", "pip", "install", 
                 "torch", "torchvision", "torchaudio", 
                 "--index-url", "https://download.pytorch.org/whl/cu124", 
                 "--no-cache-dir"])
    
    # Install Requirements
    lbl_status.config(text="Installing Libraries...")
    run_command([venv_python, "-m", "pip", "install", 
                 "customtkinter", "sounddevice", "numpy", "scipy", "openai-whisper",
                 "--no-cache-dir"])

    # 5. Launch
    lbl_status.config(text="Launching...")
    log_msg("Starting app...")
    progress.stop()
    
    subprocess.Popen([venv_python, APP_FILE], 
                     cwd=APP_DIR,
                     creationflags=subprocess.CREATE_NO_WINDOW if sys.platform=='win32' else 0)
    
    time.sleep(2)
    root.quit()

def start_thread():
    threading.Thread(target=installer_logic, daemon=True).start()

# --- GUI Setup ---
root = tk.Tk()
root.title("Local Transcriber Setup")
root.geometry("600x450")

tk.Label(root, text="Local Transcriber Pro Setup", font=("Arial", 16)).pack(pady=10)
lbl_status = tk.Label(root, text="Ready...", font=("Arial", 10))
lbl_status.pack(pady=5)

progress = ttk.Progressbar(root, orient="horizontal", length=500, mode="indeterminate")
progress.pack(pady=10)

log_text = tk.Text(root, height=15, width=70, state="disabled", font=("Consolas", 8))
log_text.pack(pady=10)

root.after(500, start_thread)
root.mainloop()
